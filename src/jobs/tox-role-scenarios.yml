description: >
  Test Ansible roles using molecule and tox-ansible. Reads environments generated by tox-ansible and executes all molecule scenarios.
  Tests can be split across multiple executors if parallelism is set to a value higher than 1.
parameters:
  parallelism:
    description: Split role tests across this number of executors
    type: integer
    default: 1
executor: default
parallelism: <<parameters.parallelism>>
steps:
  - checkout
  - install-podman-on-ubuntu
  - install-requirements-txt
  - run:
      # Need to initialize tox once to get a clean output
      command: |
        tox -l > /dev/null
        tox -l | grep ansible | grep -v "lint" | circleci tests split > /tmp/tests-to-run
        while read test; do  echo "Running test $test"; tox -e $test; done </tmp/tests-to-run
