description: Push the collection to a Github release. The GITHUB_TOKEN environment variable must be set to a valid PAT
parameters:
  python-version:
    description: Python version of the circleci python image. Must be a valid tag for the cimg/python image
    type: string
    default: "3.11"
docker:
  - image: cimg/python:<<parameters.python-version>>
resource_class: small
steps:
  - checkout
  - run:
      name: Install golang
      command: |
        sudo apt-get update && sudo apt-get install -y golang
  - install-requirements-txt
  - build-install-collection:
      install: false
      path: ./dist
  - run:
      name: Append collection to github release
      command: |
        go install github.com/tcnksm/ghr@v0.16.0
        # Filters for Semver tags, the regex is taken from the official semver page
        VERSION=$(git describe --tags --abbrev=0 | grep -P '^v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+([0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$')
        ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -replace ${VERSION} ./dist/
